<%- include('../admin/layouts/header.ejs') %>
<%- include('../admin/layouts/sidebar.ejs') %>
<%- include('../admin/layouts/navbar.ejs') %>

<div class="main-panel">
    <div class="content-wrapper">
        <div id="reloadDiv" class="container mt-5">
            <h2 class="mb-4">Order List</h2>
            <% if (order && order.length > 0) { %>
                <% for (let i = 0; i < order.length; i++) { %>
                    <div class="mb-4">
                        <p><strong>User Name:</strong> <%= order[i].user.firstName %> | <strong>Date:</strong><%= order[i].orderDate.toLocaleString() %></p>
                        <% if (order[i] && order[i].products && order[i].products.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th>num</th>
                                            <th>Product Name</th>
                                            <th>Status</th>
                                            <th>Quantity</th>
                                            <th>Price per Unit</th>
                                            <th>Total Price</th>
                                            <th>Payment Method</th>
                                            <th>Delivery Date</th>
                                            <th>Order ID</th>
                                            <th>Address</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% for (let index = 0; index < order[i].products.length; index++) { %>
                                            <tr>
                                                <td><%= index + 1 %></td>
                                                <td><%= order[i].products[index].product_Id.name %></td>
                                                <td>
                                                    <select onchange="updateStatus('<%= order[i].products[index].product_Id._id%>','<%=order[i]._id%>', this.value)">
                                                        <option value="On the way" <% if (order[i].products[index].status == 'On the way') { %> selected <% } %>>On the way</option>
                                                        <option value="Pending" <% if (order[i].products[index].status == 'Pending') { %> selected <% } %>>Pending</option>
                                                        <option value="Processing" <% if (order[i].products[index].status == 'Processing') { %> selected <% } %>>Processing</option>
                                                        <option value="delivered" <% if (order[i].products[index].status == 'delivered') { %> selected <% } %>>delivered</option>
                                                        <option value="cancelled" <% if (order[i].products[index].status == 'cancelled') { %> selected <% } %>>cancelled</option>
                                                    </select>
                                                </td>
                                                <td><%= order[i].products[index].quantity %></td>
                                                <td>$<%= order[i].products[index].product_Id.price %></td>
                                                <td>$<%= order[i].products[index].total %></td>
                                                <td><%= order[i].payment %></td>
                                                <td><%= order[i].expectedDelivery.toLocaleString() %></td>
                                                <td><%= order[i].orderID %></td>
                                                <td><%= order[i].deliveryAddress %></td>
                                            </tr>
                                        <% } %>
                                        <tr>
                                            <td colspan="9" class="text-right">Grand Total:</td>
                                            <td>$<%= order[i].totalAmount %></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <p>No order</p>
                        <% } %>
                    </div>
                <% } %>
            <% } else { %>
                <p>No order</p>
            <% } %>
            <a href="/admin/order" class="btn btn-success mb-4">Save</a>
            <a href="/admin/dashboard" class="btn btn-success mb-4 ml-3">Dashboard</a>
        </div>
    </div>
</div>

<!-- Your existing script tags... -->
<script>
    function updateStatus(productID, orderid, value) {
        $.ajax({
            url: '/admin/OrderUpdate',
            method: 'patch',
            data: {
                productID, orderid, value
            },
            success: (response) => {
                if (response.success) {
                    $('#reloadDiv').load('/admin/Order #reloadDiv')
                } else {
                    Swal.fire({
                        title: "Error",
                        icon: 'error',
                        text: response.message,
                        timer: 2000
                    })
                }
            }
        });
    }
</script>
<%- include('../admin/layouts/footer.ejs') %>
